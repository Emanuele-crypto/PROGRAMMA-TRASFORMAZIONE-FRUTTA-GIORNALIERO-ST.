<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Programma Giornaliero Trasformazione Frutta - Simone Gatto</title>
  <!-- Importazione librerie esterne -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background-color: #f8f9fa;
          padding: 20px;
      }
      
      .main-header {
          background: linear-gradient(135deg, #1e3c72, #2a5298);
          color: white;
          padding: 30px;
          border-radius: 15px;
          text-align: center;
          margin-bottom: 30px;
          box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      }
      
      .section-card {
          background: white;
          border-radius: 12px;
          padding: 25px;
          margin-bottom: 25px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.08);
          border-left: 4px solid #2a5298;
      }
      
      .section-title {
          color: #1e3c72;
          font-weight: 600;
          margin-bottom: 20px;
          padding-bottom: 10px;
          border-bottom: 2px solid #e9ecef;
      }
      
      .form-label {
          font-weight: 600;
          color: #495057;
          margin-bottom: 8px;
      }
      
      .form-control, .form-select {
          border-radius: 8px;
          border: 2px solid #e9ecef;
          padding: 12px 15px;
          font-size: 14px;
          transition: all 0.3s ease;
      }
      
      .form-control:focus, .form-select:focus {
          border-color: #2a5298;
          box-shadow: 0 0 0 0.2rem rgba(42, 82, 152, 0.25);
      }
      
      .btn-primary {
          background: linear-gradient(135deg, #1e3c72, #2a5298);
          border: none;
          border-radius: 8px;
          padding: 12px 25px;
          font-weight: 600;
          transition: all 0.3s ease;
      }
      
      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(42, 82, 152, 0.4);
      }
      
      .btn-success {
          background: linear-gradient(135deg, #28a745, #20c997);
          border: none;
          border-radius: 8px;
          padding: 8px 15px;
          font-weight: 600;
          transition: all 0.3s ease;
      }
      
      .btn-success:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
      }
      
      .btn-warning {
          background: linear-gradient(135deg, #ffc107, #ffb300);
          border: none;
          border-radius: 8px;
          padding: 8px 15px;
          font-weight: 600;
          transition: all 0.3s ease;
          color: #212529;
      }
      
      .btn-warning:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
          color: #212529;
      }
      
      .btn-info {
          background: linear-gradient(135deg, #17a2b8, #20c997);
          border: none;
          border-radius: 8px;
          padding: 12px 25px;
          font-weight: 600;
          transition: all 0.3s ease;
          color: white;
      }
      
      .btn-info:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
          color: white;
      }
      
      .calculated-field {
          background-color: #e7f3ff;
          border-color: #bee5eb;
          font-weight: 600;
      }
      
      .supplier-row {
          background-color: #f8f9fa;
          border-radius: 10px;
          padding: 20px;
          margin-bottom: 15px;
          border: 1px solid #dee2e6;
      }
      
      .bio-indicator {
          background-color: #d4edda;
          color: #155724;
          padding: 3px 8px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
      }
      
      .bio-red-text {
          color: #dc3545 !important;
          font-weight: 600;
      }
      
      .bio-black-text {
          color: #000000 !important;
          font-weight: 600;
      }
      
      .bio-red-field {
          color: #dc3545 !important;
          font-weight: 600;
          border-color: #dc3545 !important;
      }
      
      .alert-info {
          border-left: 4px solid #0dcaf0;
          background-color: #cff4fc;
          border-radius: 8px;
      }
      
      .table th {
          background-color: #1e3c72;
          color: white;
          border: none;
          font-weight: 600;
      }
      
      .table td {
          vertical-align: middle;
          border-color: #e9ecef;
      }
      
      .progress {
          height: 8px;
          border-radius: 4px;
      }
      
      .hidden-field {
          display: none;
      }
      
      .time-display {
          font-family: 'Courier New', monospace;
          font-size: 16px;
          font-weight: bold;
          color: #1e3c72;
      }
      
      .yield-result {
          background-color: #e8f5e8;
          border-color: #28a745;
          font-weight: 600;
          text-align: center;
      }
      
      .revision-info {
          font-size: 12px;
          color: #6c757d;
          margin-top: 10px;
      }
      
      .supplier-selection {
          background-color: #e8f5e8;
          border: 2px solid #28a745;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 15px;
      }
      
      .next-day {
          color: #dc3545;
          font-weight: bold;
          font-size: 12px;
      }
      
      .combination-result {
          background-color: #fff3cd;
          border: 2px solid #ffc107;
          font-weight: bold;
          color: #856404;
      }
      
      .auto-sum-field {
          background-color: #fffacd !important;
          border: 2px solid #ffd700 !important;
          font-weight: bold;
      }
      
      .note-field {
          min-height: 60px;
          resize: vertical;
      }
      
      .select2-container {
          width: 100% !important;
      }
      
      .select2-container--default .select2-selection--multiple {
          border: 2px solid #e9ecef;
          border-radius: 8px;
          min-height: 45px;
          padding: 5px;
      }
      
      .select2-container--default.select2-container--focus .select2-selection--multiple {
          border-color: #2a5298;
          box-shadow: 0 0 0 0.2rem rgba(42, 82, 152, 0.25);
      }
      
      .sum-details {
          font-size: 11px;
          color: #856404;
          font-weight: normal;
          margin-top: 5px;
      }
      
      /* Stili per la pagina statistiche */
      .stats-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
          display: none;
          z-index: 1000;
      }
      
      .stats-content {
          position: relative;
          background-color: white;
          margin: 2% auto;
          padding: 20px;
          width: 90%;
          max-width: 1400px;
          height: 90%;
          border-radius: 15px;
          overflow-y: auto;
      }
      
      .stats-header {
          background: linear-gradient(135deg, #1e3c72, #2a5298);
          color: white;
          padding: 20px;
          border-radius: 10px;
          margin-bottom: 20px;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      
      .close-stats {
          color: white;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
      }
      
      .close-stats:hover {
          color: #f0f0f0;
      }
      
      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
          gap: 20px;
      }
      
      .stats-card {
          background: white;
          border-radius: 10px;
          padding: 20px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.08);
          border-left: 4px solid #2a5298;
      }
      
      .chart-container {
          position: relative;
          height: 300px;
          margin-top: 20px;
      }
      
      .stats-summary {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
          margin-bottom: 30px;
      }
      
      .summary-item {
          background: linear-gradient(135deg, #e7f3ff, #f0f8ff);
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      }
      
      .summary-value {
          font-size: 36px;
          font-weight: bold;
          color: #1e3c72;
      }
      
      .summary-label {
          font-size: 14px;
          color: #6c757d;
          margin-top: 5px;
      }
  </style>
</head>
<body>
  <div class="container-fluid">
      <!-- Header principale -->
      <div class="main-header">
          <h1><i class="bi bi-calendar-check"></i> PROGRAMMA GIORNALIERO TRASFORMAZIONE FRUTTA</h1>
          <h4>Sistema di Gestione Produzione - Simone Gatto</h4>
          <p class="mb-0">Data: <span id="current-date"></span></p>
          <div class="revision-info">
              Ultima revisione: <span id="last-revision"></span>
          </div>
      </div>

      <!-- Sezione Selezione Tipo Agrume -->
      <div class="section-card">
          <h3 class="section-title"><i class="bi bi-gear-fill"></i> Tipo di Agrume</h3>
          <div class="row">
              <div class="col-md-6">
                  <label for="tipo-agrume-giornaliero" class="form-label">Seleziona Tipo di Agrume</label>
                  <select class="form-select" id="tipo-agrume-giornaliero" required>
                      <option value="">Seleziona il tipo di agrume</option>
                      <option value="LIMONE">Limone</option>
                      <option value="ARANCIA">Arancia</option>
                      <option value="MANDARINO">Mandarino</option>
                      <option value="POMPELMO">Pompelmo</option>
                      <option value="BERGAMOTTO">Bergamotto</option>
                  </select>
              </div>
              <div class="col-md-6">
                  <label for="data-lavorazione" class="form-label">Data Lavorazione</label>
                  <input type="date" class="form-control" id="data-lavorazione" required>
              </div>
          </div>
      </div>

      <!-- Sezione Totali -->
      <div class="section-card">
          <h3 class="section-title"><i class="bi bi-boxes"></i> Quantità Totali</h3>
          <div class="row">
              <div class="col-md-4">
                  <label for="entrata-giornaliera" class="form-label">Entrata Giornaliera Totale (kg)</label>
                  <input type="number" class="form-control calculated-field" id="entrata-giornaliera" readonly>
              </div>
              <div class="col-md-4">
                  <label for="trasformata-totale" class="form-label">Quantità trasformata Totale (kg)</label>
                  <input type="number" class="form-control calculated-field" id="trasformata-totale" readonly>
              </div>
              <div class="col-md-4">
                  <label for="giacenza-totale" class="form-label">Giacenza Totale (kg)</label>
                  <input type="number" class="form-control calculated-field" id="giacenza-totale" readonly>
              </div>
          </div>
      </div>

      <!-- Sezione Fornitori -->
      <div class="section-card">
          <h3 class="section-title"><i class="bi bi-truck"></i> Dettagli Fornitori e Lavorazione</h3>
          <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> Aggiungi i fornitori e configura i parametri di lavorazione per ciascuno. L'orario di fine verrà calcolato automaticamente.
          </div>
          
          <div id="fornitori-container">
              <!-- I fornitori verranno aggiunti dinamicamente qui -->
          </div>
          
          <button type="button" class="btn btn-primary" id="aggiungi-fornitore">
              <i class="bi bi-plus-circle"></i> Aggiungi Fornitore
          </button>
      </div>

      <!-- Sezione Selezione Combinazioni Fornitori (mostrata solo dopo aggiunta fornitori) -->
      <div id="combinazioni-section" class="section-card hidden-field">
          <h3 class="section-title"><i class="bi bi-diagram-3"></i> Selezione Combinazioni Fornitori</h3>
          <div class="supplier-selection">
              <div class="row">
                  <div class="col-md-12">
                      <label class="form-label">Seleziona Fornitori da Combinare per Succo 1ª</label>
                      <select class="form-select" id="combinazione-fornitori">
                          <option value="">Seleziona combinazione</option>
                          <!-- Opzioni generate dinamicamente -->
                      </select>
                      <div class="mt-3">
                          <button type="button" class="btn btn-success me-2" id="applica-combinazione">
                              <i class="bi bi-check-circle"></i> Applica Combinazione
                          </button>
                          <button type="button" class="btn btn-warning" id="reset-combinazione">
                              <i class="bi bi-x-circle"></i> Reset Combinazione
                          </button>
                          <small class="text-muted d-block mt-2">
                              Il risultato sostituirà la quantità succo 1ª nell'ultimo fornitore incluso nella combinazione
                          </small>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- Sezione Riepilogo Lavorazione -->
      <div class="section-card">
          <h3 class="section-title"><i class="bi bi-graph-up"></i> Riepilogo Programma Lavorazione</h3>
          <div class="table-responsive">
              <table class="table table-hover" id="riepilogo-table">
                  <thead>
                      <tr>
                          <th>Fornitore</th>
                          <th>Q. Entrata (kg)</th>
                          <th>Q. Da trasformare (kg)</th>
                          <th>Giacenza (kg)</th>
                          <th>Certificazione</th>
                          <th>Linea</th>
                          <th>Inizio</th>
                          <th>Fine</th>
                          <th>Durata</th>
                          <th>Azioni</th>
                      </tr>
                  </thead>
                  <tbody>
                      <!-- Dati caricati dinamicamente -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- Pulsanti di azione -->
      <div class="section-card text-center">
          <button type="button" class="btn btn-primary btn-lg me-3" id="salva-programma">
              <i class="bi bi-save"></i> Salva Programma
          </button>
          <button type="button" class="btn btn-outline-secondary btn-lg me-3" id="anteprima-stampa">
              <i class="bi bi-printer"></i> Anteprima Stampa
          </button>
          <button type="button" class="btn btn-info btn-lg me-3" id="apri-statistiche">
              <i class="bi bi-bar-chart-line"></i> Statistiche Interattive
          </button>
          <button type="button" class="btn btn-outline-danger btn-lg" id="reset-programma">
              <i class="bi bi-arrow-clockwise"></i> Reset Programma
          </button>
      </div>
  </div>

  <!-- Modal Statistiche -->
  <div id="stats-modal" class="stats-modal">
      <div class="stats-content">
          <div class="stats-header">
              <h2><i class="bi bi-bar-chart-line"></i> Statistiche Interattive Produzione</h2>
              <span class="close-stats">&times;</span>
          </div>
          
          <div class="stats-summary" id="stats-summary">
              <!-- Sommario statistiche caricate dinamicamente -->
          </div>
          
          <div class="stats-grid">
              <div class="stats-card">
                  <h4>Distribuzione Produzione per Fornitore</h4>
                  <div class="chart-container">
                      <canvas id="chartFornitori"></canvas>
                  </div>
              </div>
              
              <div class="stats-card">
                  <h4>Rese Medie per Tipo Prodotto</h4>
                  <div class="chart-container">
                      <canvas id="chartRese"></canvas>
                  </div>
              </div>
              
              <div class="stats-card">
                  <h4>Distribuzione Certificazioni</h4>
                  <div class="chart-container">
                      <canvas id="chartCertificazioni"></canvas>
                  </div>
              </div>
              
              <div class="stats-card">
                  <h4>Timeline Produzione</h4>
                  <div class="chart-container">
                      <canvas id="chartTimeline"></canvas>
                  </div>
              </div>
              
              <div class="stats-card">
                  <h4>Efficienza Linee di Produzione</h4>
                  <div class="chart-container">
                      <canvas id="chartEfficienza"></canvas>
                  </div>
              </div>
              
              <div class="stats-card">
                  <h4>Analisi Destinazioni Prodotti</h4>
                  <div class="chart-container">
                      <canvas id="chartDestinazioni"></canvas>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- Template per fornitore -->
  <div id="fornitore-template" class="hidden-field">
      <div class="supplier-row" data-supplier-index="">
          <div class="d-flex justify-content-between align-items-center mb-3">
              <h5><i class="bi bi-building"></i> Fornitore <span class="supplier-number"></span></h5>
              <button type="button" class="btn btn-outline-danger btn-sm rimuovi-fornitore">
                  <i class="bi bi-trash"></i> Rimuovi
              </button>
          </div>
          
          <div class="row g-3">
              <!-- Dati base fornitore -->
              <div class="col-md-3">
                  <label class="form-label">Nome Fornitore</label>
                  <select class="form-select nome-fornitore" required>
                      <option value="">Seleziona fornitore</option>
                      <option value="RESTUCCIA">RESTUCCIA</option>
                      <option value="CI">CI</option>
                      <option value="ARCO">ARCO</option>
                      <option value="GIOVINAZZO">GIOVINAZZO</option>
                      <option value="AZ.T.C.">AZ.T.C.</option>
                      <option value="VASTA">VASTA</option>
                      <option value="ALTRO">ALTRO</option>
                  </select>
                  <input type="text" class="form-control mt-2 altro-fornitore hidden-field" placeholder="Specifica altro fornitore">
              </div>
              
              <div class="col-md-3">
                  <label class="form-label">Quantità in Entrata (kg)</label>
                  <input type="number" class="form-control quantita-fornitore" min="0" required>
              </div>
              
              <div class="col-md-3">
                  <label class="form-label">Quantità trasformata (kg)</label>
                  <input type="number" class="form-control quantita-trasformata" min="0" placeholder="0">
              </div>
              
              <div class="col-md-3">
                  <label class="form-label">Giacenza (kg)</label>
                  <input type="number" class="form-control calculated-field giacenza-fornitore" readonly>
              </div>
              
              <div class="col-md-6">
                  <label class="form-label">Certificazione Prodotto</label>
                  <select class="form-select certificazione-prodotto" required>
                      <option value="">Seleziona certificazione</option>
                      <option value="BIO EU">BIO EU</option>
                      <option value="BIO DEM">BIO DEM</option>
                      <option value="BIO NTD">BIO NTD</option>
                      <option value="TRACCIATO">TRACCIATO</option>
                      <option value="IGP">IGP</option>
                      <option value="CONVENZIONALE">CONVENZIONALE</option>
                      <option value="ALTRO">ALTRO</option>
                  </select>
                  <input type="text" class="form-control mt-2 altra-certificazione hidden-field" placeholder="Specifica altra certificazione">
              </div>
              
              <!-- Parametri lavorazione -->
              <div class="col-md-6">
                  <label class="form-label">Linea di Trasformazione</label>
                  <select class="form-select linea-trasformazione" required>
                      <option value="">Seleziona linea</option>
                      <option value="BOE/1100">BOE/1100</option>
                      <option value="GOE INT/POLY">GOE INT/POLY</option>
                      <option value="GOE EST/POLY">GOE EST/POLY</option>
                      <option value="GOE EST/400">GOE EST/400</option>
                      <option value="B/SF">B/SF</option>
                      <option value="TORCHI FASO">TORCHI FASO</option>
                  </select>
              </div>
              
              <div class="col-md-6">
                  <label class="form-label">Portata Impianto (kg/h)</label>
                  <input type="number" class="form-control portata-impianto" min="100" max="5000" required>
              </div>
              
              <div class="col-md-6">
                  <label class="form-label">Orario Inizio Lavorazione stimato</label>
                  <input type="time" class="form-control orario-inizio" required>
              </div>
              
              <div class="col-md-6">
                  <label class="form-label">Orario Fine Lavorazione stimato</label>
                  <div class="orario-fine-display calculated-field form-control"></div>
              </div>
              
              <div class="col-md-6">
                  <label class="form-label">Durata Lavorazione stimata</label>
                  <input type="text" class="form-control calculated-field durata-lavorazione" readonly>
              </div>
          </div>
          
          <!-- Sezione Rese e Destinazioni -->
          <div class="mt-4">
              <h6><i class="bi bi-droplet"></i> Calcolo Rese e Destinazioni Spremiture</h6>
              
              <div class="row g-3 mt-2">
                  <!-- Rese percentuali -->
                  <div class="col-md-4">
                      <label class="form-label">Resa Succo 1ª (%)</label>
                      <input type="number" class="form-control resa-prima" step="0.1" min="0" max="100" placeholder="Auto">
                  </div>
                  
                  <div class="col-md-4">
                      <label class="form-label">Resa Succo 2ª (%)</label>
                      <input type="number" class="form-control resa-seconda" step="0.1" min="0" max="100" placeholder="Auto">
                  </div>
                  
                  <div class="col-md-4">
                      <label class="form-label">Resa Torchiato (%)</label>
                      <input type="number" class="form-control resa-torchiato" step="0.1" min="0" max="100" placeholder="Auto">
                  </div>
              </div>
              
              <!-- Risultati calcolo rese in kg -->
              <div class="row g-3 mt-2">
                  <div class="col-md-4">
                      <label class="form-label">Quantità Succo 1ª (kg)</label>
                      <input type="number" class="form-control yield-result quantita-prima" readonly>
                  </div>
                  
                  <div class="col-md-4">
                      <label class="form-label">Quantità Succo 2ª (kg)</label>
                      <input type="number" class="form-control yield-result quantita-seconda" readonly>
                      <div class="sum-details seconda-details"></div>
                  </div>
                  
                  <div class="col-md-4">
                      <label class="form-label">Quantità Torchiato (kg)</label>
                      <input type="number" class="form-control yield-result quantita-torchiato" readonly>
                      <div class="sum-details torchiato-details"></div>
                  </div>
              </div>
              
              <!-- Destinazioni spremiture -->
              <div class="row g-3 mt-3">
                  <div class="col-md-4">
                      <label class="form-label destinazione-prima-label">Destinazione Succo 1ª</label>
                      <select class="form-select destinazione-prima" multiple>
                          <option value="NAT IN TINI">NAT IN TINI</option>
                          <option value="PET 100">PET 100</option>
                          <option value="PET 200">PET 200</option>
                          <option value="PET 480">PET 480</option>
                          <option value="ACMA">ACMA</option>
                          <option value="REX">REX</option>
                          <option value="GOGLIO">GOGLIO</option>
                          <option value="VASCHETTE">VASCHETTE</option>
                          <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                          <option value="LATTE">LATTE</option>
                          <option value="F.F.">F.F.</option>
                          <option value="F.T.C">F.T.C</option>
                          <option value="FBL">FBL</option>
                          <option value="BIC">BIC</option>
                          <option value="CISTERNA P">CISTERNA P</option>
                          <option value="CISTERNA EF">CISTERNA EF</option>
                          <option value="CISTERNA VK">CISTERNA VK</option>
                          <option value="CISTERNA GS">CISTERNA GS</option>
                         <option value="CISTERNA CARTH.">CISTERNA CARTH.</option>
                         <option value="CONCENTRATO">CONCENTRATO</option>
                         <option value="ALTRO">ALTRO</option>
                     </select>
                     <select class="form-select mt-2 bx-concentrato hidden-field">
                         <option value="">Seleziona °BX</option>
                         <option value="32">32 °BX</option>
                         <option value="40">40 °BX</option>
                         <option value="45">45 °BX</option>
                         <option value="48">48 °BX</option>
                         <option value="55">55 °BX</option>
                         <option value="58">58 °BX</option>
                         <option value="60">60 °BX</option>
                         <option value="63.5">63.5 °BX</option>
                         <option value="65">65 °BX</option>
                     </select>
                     <input type="text" class="form-control mt-2 altra-destinazione hidden-field" placeholder="Specifica altra destinazione">
                 </div>
                 
                 <div class="col-md-4">
                     <label class="form-label">Destinazione Succo 2ª</label>
                     <select class="form-select destinazione-seconda">
                         <option value="">Seleziona destinazione</option>
                         <option value="NAT IN TINI">NAT IN TINI</option>
                         <option value="CONCENTRATO">CONCENTRATO</option>
                         <option value="ALTRO">ALTRO</option>
                     </select>
                     <select class="form-select mt-2 bx-concentrato hidden-field">
                         <option value="">Seleziona °BX</option>
                         <option value="32">32 °BX</option>
                         <option value="40">40 °BX</option>
                         <option value="45">45 °BX</option>
                         <option value="48">48 °BX</option>
                         <option value="55">55 °BX</option>
                         <option value="58">58 °BX</option>
                         <option value="60">60 °BX</option>
                         <option value="63.5">63.5 °BX</option>
                         <option value="65">65 °BX</option>
                     </select>
                     <input type="text" class="form-control mt-2 altra-destinazione hidden-field" placeholder="Specifica altra destinazione">
                 </div>
                 
                 <div class="col-md-4">
                     <label class="form-label">Destinazione Torchiato</label>
                     <select class="form-select destinazione-torchiato">
                         <option value="">Seleziona destinazione</option>
                         <option value="NAT IN TINI">NAT IN TINI</option>
                         <option value="F.F.">F.F.</option>
                         <option value="F.T.C">F.T.C</option>
                         <option value="FBL">FBL</option>
                         <option value="BIC">BIC</option>
                         <option value="CONCENTRATO">CONCENTRATO</option>
                         <option value="ALTRO">ALTRO</option>
                     </select>
                     <input type="text" class="form-control mt-2 altra-destinazione hidden-field" placeholder="Specifica altra destinazione">
                 </div>
             </div>
             
             <!-- Pastorizzazione -->
             <div class="row g-3 mt-3">
                 <div class="col-md-4">
                     <label class="form-label">Pastorizzato</label>
                     <select class="form-select pastorizzato-prima">
                         <option value="SI">SI</option>
                         <option value="NO">NO</option>
                     </select>
                 </div>
                 
                 <div class="col-md-4">
                     <label class="form-label">Pastorizzato</label>
                     <select class="form-select pastorizzato-seconda">
                         <option value="SI">SI</option>
                         <option value="NO">NO</option>
                     </select>
                 </div>
                 
                 <div class="col-md-4">
                     <label class="form-label">Pastorizzato</label>
                     <select class="form-select pastorizzato-torchiato">
                         <option value="SI">SI</option>
                         <option value="NO">NO</option>
                     </select>
                 </div>
             </div>
             
             <!-- Tenore di polpa, Brix e Bio per ogni prodotto -->
             <div class="row g-3 mt-3">
                 <div class="col-md-4">
                     <label class="form-label">Tenore Polpa Succo 1ª</label>
                     <select class="form-select tenore-polpa-prima">
                         <option value="STANDARD">STANDARD</option>
                         <option value="LIMPIDO">LIMPIDO</option>
                         <option value="SEMICLEAR">SEMICLEAR</option>
                         <option value="1%">1%</option>
                         <option value="2%">2%</option>
                         <option value="3%">3%</option>
                         <option value="6%">6%</option>
                         <option value="ALTRO">ALTRO</option>
                     </select>
                     <input type="text" class="form-control mt-2 altro-tenore-prima hidden-field" placeholder="Specifica altro tenore">
                     
                     <label class="form-label mt-2">Brix</label>
                     <select class="form-select brix-prima">
                         <option value="NAT">NAT</option>
                         <option value="20">20</option>
                         <option value="32">32</option>
                         <option value="40">40</option>
                         <option value="41">41</option>
                         <option value="45">45</option>
                         <option value="55">55</option>
                         <option value="58">58</option>
                         <option value="60">60</option>
                         <option value="63.5">63.5</option>
                         <option value="65">65</option>
                         <option value="ALTRO">ALTRO</option>
                     </select>
                     <input type="text" class="form-control mt-2 altro-brix-prima hidden-field" placeholder="Specifica altro Brix">
                     
                     <label class="form-label mt-2">Biologico</label>
                     <select class="form-select bio-prima">
                         <option value="SI">SI</option>
                         <option value="NO">NO</option>
                         <option value="DECLASSATO">DECLASSATO</option>
                     </select>
                     
                     <label class="form-label mt-2">Conservato</label>
                     <select class="form-select conservato-prima">
                         <option value="SI">SI</option>
                         <option value="NO">NO</option>
                     </select>
                     
                     <label class="form-label mt-2">Note</label>
                     <textarea class="form-control note-field note-prima" placeholder="Inserisci note per Succo 1ª"></textarea>
                 </div>
                 
                 <div class="col-md-4">
                     <label class="form-label">Tenore Polpa Succo 2ª</label>
                     <select class="form-select tenore-polpa-seconda">
                         <option value="STANDARD">STANDARD</option>
                         <option value="LIMPIDO">LIMPIDO</option>
                         <option value="SEMICLEAR">SEMICLEAR</option>
                         <option value="1%">1%</option>
                         <option value="2%">2%</option>
                         <option value="3%">3%</option>
                         <option value="6%">6%</option>
                         <option value="ALTRO">ALTRO</option>
                     </select>
                     <input type="text" class="form-control mt-2 altro-tenore-seconda hidden-field" placeholder="Specifica altro tenore">
                     
                     <label class="form-label mt-2">Brix</label>
                     <select class="form-select brix-seconda">
                         <option value="NAT">NAT</option>
                         <option value="20">20</option>
                         <option value="32">32</option>
                         <option value="40">40</option>
                         <option value="41">41</option>
                         <option value="45">45</option>
                         <option value="55">55</option>
                         <option value="58">58</option>
                         <option value="60">60</option>
                         <option value="63.5">63.5</option>
                         <option value="65">65</option>
                         <option value="ALTRO">ALTRO</option>
                     </select>
                     <input type="text" class="form-control mt-2 altro-brix-seconda hidden-field" placeholder="Specifica altro Brix">
                     
                     <label class="form-label mt-2">Conservato</label>
                     <select class="form-select conservato-seconda">
                         <option value="SI">SI</option>
                         <option value="NO">NO</option>
                     </select>
                     
                     <label class="form-label mt-2">Note</label>
                     <textarea class="form-control note-field note-seconda" placeholder="Inserisci note per Succo 2ª"></textarea>
                 </div>
                 
                 <div class="col-md-4">
                     <label class="form-label">Tenore Polpa Torchiato</label>
                     <select class="form-select tenore-polpa-torchiato">
                         <option value="STANDARD">STANDARD</option>
                         <option value="LIMPIDO">LIMPIDO</option>
                         <option value="SEMICLEAR">SEMICLEAR</option>
                         <option value="1%">1%</option>
                         <option value="2%">2%</option>
                         <option value="3%">3%</option>
                         <option value="6%">6%</option>
                         <option value="ALTRO">ALTRO</option>
                     </select>
                     <input type="text" class="form-control mt-2 altro-tenore-torchiato hidden-field" placeholder="Specifica altro tenore">
                     
                     <label class="form-label mt-2">Brix</label>
                     <select class="form-select brix-torchiato">
                         <option value="NAT">NAT</option>
                         <option value="20">20</option>
                         <option value="32">32</option>
                         <option value="40">40</option>
                         <option value="41">41</option>
                         <option value="45">45</option>
                         <option value="55">55</option>
                         <option value="58">58</option>
                         <option value="60">60</option>
                         <option value="63.5">63.5</option>
                         <option value="65">65</option>
                         <option value="ALTRO">ALTRO</option>
                     </select>
                     <input type="text" class="form-control mt-2 altro-brix-torchiato hidden-field" placeholder="Specifica altro Brix">
                     
                     <label class="form-label mt-2">Conservato</label>
                     <select class="form-select conservato-torchiato">
                         <option value="SI">SI</option>
                         <option value="NO">NO</option>
                     </select>
                     
                     <label class="form-label mt-2">Note</label>
                     <textarea class="form-control note-field note-torchiato" placeholder="Inserisci note per Torchiato"></textarea>
                 </div>
             </div>
         </div>
     </div>
 </div>

 <script>
     $(document).ready(function() {
         let supplierCount = 0;
         let programData = {};
         let lastCombinationSuppliers = '';
         let sumDetailsSeconda = {};
         let sumDetailsTorchiato = {};
         let chartsInitialized = false;
         let charts = {};
         
         // Inizializzazione data corrente e ultima revisione
         function initCurrentDate() {
             const today = new Date();
             const formatted = today.toLocaleDateString('it-IT', {
                 weekday: 'long',
                 year: 'numeric',
                 month: 'long',
                 day: 'numeric'
             });
             $('#current-date').text(formatted);
             $('#data-lavorazione').val(today.toISOString().split('T')[0]);
             
             updateLastRevision();
         }
         
         // Aggiorna ultima revisione
         function updateLastRevision() {
             const now = new Date();
             const lastRevision = now.toLocaleDateString('it-IT') + ' - ' + now.toLocaleTimeString('it-IT');
             $('#last-revision').text(lastRevision);
         }
         
         // Calcolo automatico rese in base al tipo di agrume
         function calculateAutoYields(agrume) {
             const yields = {
                 'LIMONE': { prima: 30, seconda: 10, torchiato: 5 },
                 'ARANCIA': { prima: 35, seconda: 0, torchiato: 6 },
                 'MANDARINO': { prima: 42, seconda: 0, torchiato: 4 },
                 'POMPELMO': { prima: 30, seconda: 0, torchiato: 6 },
                 'BERGAMOTTO': { prima: 30, seconda: 0, torchiato: 3 }
             };
             return yields[agrume] || { prima: 45, seconda: 10, torchiato: 4 };
         }
         
         // Mostra/nasconde sezione combinazioni
         function toggleCombinazioniSection() {
             const hasSuppliers = $('.supplier-row').length > 0;
             
             if (hasSuppliers) {
                 $('#combinazioni-section').removeClass('hidden-field');
             } else {
                 $('#combinazioni-section').addClass('hidden-field');
             }
         }
         
         // Trova l'ultimo fornitore incluso in una combinazione
         function getLastSupplierInCombination(comboValue) {
             const indexes = comboValue.split(',').map(i => parseInt(i));
             const maxIndex = Math.max(...indexes);
             return $(`[data-supplier-index="${maxIndex}"]`);
         }
         
         // Trova l'ultimo fornitore
         function getLastSupplier() {
             let lastSupplier = null;
             let maxIndex = 0;
             
             $('.supplier-row').each(function() {
                 const index = parseInt($(this).attr('data-supplier-index'));
                 if (index > maxIndex) {
                     maxIndex = index;
                     lastSupplier = $(this);
                 }
             });
             
             return lastSupplier;
         }
         
         // Calcola dettagli somma per ogni fornitore
         function calculateSumDetails() {
             const suppliers = $('.supplier-row');
             const details = [];
             
             suppliers.each(function() {
                 const nome = $(this).find('.nome-fornitore').val();
                 const altroNome = $(this).find('.altro-fornitore').val();
                 const nomeFornitore = nome === 'ALTRO' ? altroNome : nome;
                 
                 const quantitaTrasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
                 const resaSeconda = parseFloat($(this).find('.resa-seconda').val()) || 0;
                 const resaTorchiato = parseFloat($(this).find('.resa-torchiato').val()) || 0;
                 
                 if (nomeFornitore && quantitaTrasformata > 0) {
                     const qtaSeconda = (quantitaTrasformata * resaSeconda / 100).toFixed(1);
                     const qtaTorchiato = (quantitaTrasformata * resaTorchiato / 100).toFixed(1);
                     
                     details.push({
                         nome: nomeFornitore,
                         seconda: qtaSeconda,
                         torchiato: qtaTorchiato
                     });
                 }
             });
             
             return details;
         }
         
         // Formatta dettagli somma
         function formatSumDetails(details, type) {
             if (details.length <= 1) return '';
             
             const parts = details.map(d => `${d.nome} = ${d[type]} kg`);
             return parts.join(' + ');
         }
         
         // Aggiorna somme automatiche per l'ultimo fornitore
         function updateAutoSums() {
             const suppliers = $('.supplier-row');
             if (suppliers.length === 0) return;
             
             const lastSupplier = getLastSupplier();
             
             if (suppliers.length === 1) {
                 // Con un solo fornitore, calcola normalmente
                 const quantitaTrasformata = parseFloat(lastSupplier.find('.quantita-trasformata').val()) || 0;
                 const resaSeconda = parseFloat(lastSupplier.find('.resa-seconda').val()) || 0;
                 const resaTorchiato = parseFloat(lastSupplier.find('.resa-torchiato').val()) || 0;
                 
                 const qtaSeconda = (quantitaTrasformata * resaSeconda / 100).toFixed(1);
                 const qtaTorchiato = (quantitaTrasformata * resaTorchiato / 100).toFixed(1);
                 
                 lastSupplier.find('.quantita-seconda').val(qtaSeconda).removeClass('auto-sum-field');
                 lastSupplier.find('.quantita-torchiato').val(qtaTorchiato).removeClass('auto-sum-field');
                 lastSupplier.find('.seconda-details').html('');
                 lastSupplier.find('.torchiato-details').html('');
                 
                 // Rimuovi gli stili da tutti
                 suppliers.find('.quantita-seconda, .quantita-torchiato').removeClass('auto-sum-field');
             } else {
                 // Con più fornitori, calcola le somme
                 let totalSeconda = 0;
                 let totalTorchiato = 0;
                 
                 suppliers.each(function() {
                     const quantitaTrasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
                     const resaSeconda = parseFloat($(this).find('.resa-seconda').val()) || 0;
                     const resaTorchiato = parseFloat($(this).find('.resa-torchiato').val()) || 0;
                     
                     if (quantitaTrasformata > 0) {
                         totalSeconda += (quantitaTrasformata * resaSeconda / 100);
                         totalTorchiato += (quantitaTrasformata * resaTorchiato / 100);
                     }
                 });
                 
                 // Rimuovi gli stili da tutti i fornitori
                 suppliers.find('.quantita-seconda, .quantita-torchiato').removeClass('auto-sum-field');
                 suppliers.find('.seconda-details, .torchiato-details').html('');
                 
                 // Calcola i valori individuali per gli altri fornitori
                 suppliers.not(lastSupplier).each(function() {
                     const quantitaTrasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
                     const resaSeconda = parseFloat($(this).find('.resa-seconda').val()) || 0;
                     const resaTorchiato = parseFloat($(this).find('.resa-torchiato').val()) || 0;
                     
                     const qtaSeconda = (quantitaTrasformata * resaSeconda / 100).toFixed(1);
                     const qtaTorchiato = (quantitaTrasformata * resaTorchiato / 100).toFixed(1);
                     
                     $(this).find('.quantita-seconda').val(qtaSeconda);
                     $(this).find('.quantita-torchiato').val(qtaTorchiato);
                 });
                 
                 // Applica le somme solo all'ultimo fornitore
                 lastSupplier.find('.quantita-seconda').val(totalSeconda.toFixed(1)).addClass('auto-sum-field');
                 lastSupplier.find('.quantita-torchiato').val(totalTorchiato.toFixed(1)).addClass('auto-sum-field');
                 
                 // Aggiungi dettagli somma
                 const details = calculateSumDetails();
                 const secondaDetails = formatSumDetails(details, 'seconda');
                 const torchiatoDetails = formatSumDetails(details, 'torchiato');
                 
                 if (secondaDetails) {
                     lastSupplier.find('.seconda-details').html(`<strong>Dettaglio:</strong> ${secondaDetails}`);
                 }
                 if (torchiatoDetails) {
                     lastSupplier.find('.torchiato-details').html(`<strong>Dettaglio:</strong> ${torchiatoDetails}`);
                 }
                 
                 // Salva i dettagli globalmente
                 sumDetailsSeconda = details;
                 sumDetailsTorchiato = details;
             }
         }
         
         // Aggiorna opzioni select per combinazioni fornitori
         function updateCombinazioneOptions() {
             const select = $('#combinazione-fornitori');
             
             select.empty().append('<option value="">Seleziona combinazione</option>');
             
             const fornitori = [];
             $('.supplier-row').each(function() {
                 const index = $(this).data('supplier-index');
                 const fornitore = $(this).find('.nome-fornitore').val() || '';
                 const altroFornitore = $(this).find('.altro-fornitore').val();
                 const nomeFornitore = fornitore === 'ALTRO' ? altroFornitore : fornitore;
                 
                 if (nomeFornitore) {
                     fornitori.push({ index: index, nome: nomeFornitore });
                 }
             });
             
             // Genera combinazioni possibili
             for (let i = 0; i < fornitori.length; i++) {
                 for (let j = i + 1; j < fornitori.length; j++) {
                     const combo = `${fornitori[i].index},${fornitori[j].index}`;
                     const label = `${fornitori[i].nome} + ${fornitori[j].nome}`;
                     select.append(`<option value="${combo}">${label}</option>`);
                 }
             }
             
             // Combinazione di tutti i fornitori se ce ne sono più di 2
             if (fornitori.length > 2) {
                 const allIndexes = fornitori.map(f => f.index).join(',');
                 const allNames = fornitori.map(f => f.nome).join(' + ');
                 select.append(`<option value="${allIndexes}">Tutti: ${allNames}</option>`);
             }
         }
         
         // Ottieni nomi fornitori dalla combinazione
         function getSupplierNamesFromCombo(comboValue) {
             const indexes = comboValue.split(',');
             const names = [];
             
             indexes.forEach(index => {
                 const supplierRow = $(`[data-supplier-index="${index}"]`);
                 const fornitore = supplierRow.find('.nome-fornitore').val() || '';
                 const altroFornitore = supplierRow.find('.altro-fornitore').val();
                 const nomeFornitore = fornitore === 'ALTRO' ? altroFornitore : fornitore;
                 if (nomeFornitore) {
                     names.push(nomeFornitore);
                 }
             });
             
             return names.join(' + ');
         }
         
         // Applica combinazione sostituendo quantità succo 1ª nell'ultimo fornitore incluso
         function applyCombination() {
             const selectedCombo = $('#combinazione-fornitori').val();
             if (!selectedCombo) {
                 alert('Seleziona prima una combinazione di fornitori');
                 return;
             }
             
             const indexes = selectedCombo.split(',');
             let totale = 0;
             
             indexes.forEach(index => {
                 const supplierRow = $(`[data-supplier-index="${index}"]`);
                 const quantitaTrasformata = parseFloat(supplierRow.find('.quantita-trasformata').val()) || 0;
                 const resaPrima = parseFloat(supplierRow.find('.resa-prima').val()) || 0;
                 
                 if (quantitaTrasformata > 0) {
                     totale += (quantitaTrasformata * resaPrima / 100);
                 }
             });
             
             const lastSupplierInCombo = getLastSupplierInCombination(selectedCombo);
             if (lastSupplierInCombo.length > 0) {
                 const quantitaPrimaField = lastSupplierInCombo.find('.quantita-prima');
                 quantitaPrimaField.val(totale.toFixed(1));
                 quantitaPrimaField.addClass('combination-result');
                 
                 lastCombinationSuppliers = getSupplierNamesFromCombo(selectedCombo);
                 
                 const noteElement = lastSupplierInCombo.find('.combination-note');
                 if (noteElement.length === 0) {
                     quantitaPrimaField.after(`<small class="combination-note text-warning d-block">Valore da combinazione fornitori: ${lastCombinationSuppliers}</small>`);
                 } else {
                     noteElement.text(`Valore da combinazione fornitori: ${lastCombinationSuppliers}`);
                 }
                 
                 alert(`Combinazione applicata! Quantità succo 1ª dell'ultimo fornitore incluso aggiornata a ${totale.toFixed(1)} kg\nFornitori combinati: ${lastCombinationSuppliers}`);
             } else {
                 alert('Nessun fornitore disponibile per applicare la combinazione');
             }
         }
         
         // Reset combinazione
         function resetCombination() {
             $('.supplier-row').each(function() {
                 const quantitaPrimaField = $(this).find('.quantita-prima');
                 
                 if (quantitaPrimaField.hasClass('combination-result')) {
                     // Rimuovi la classe combination-result
                     quantitaPrimaField.removeClass('combination-result');
                     
                     // Rimuovi la nota di combinazione
                     $(this).find('.combination-note').remove();
                     
                     // Ricalcola il valore basandosi sulla resa
                     calculateYieldQuantities($(this));
                 }
             });
             
             // Reset del select combinazioni
             $('#combinazione-fornitori').val('');
             
             // Reset della variabile memorizzata
             lastCombinationSuppliers = '';
             
             alert('Combinazione rimossa. I valori del succo 1ª sono stati ricalcolati in base alle rese.');
         }
         
         // Aggiorna stili BIO per certificazione e linea
         function updateBioStyles(supplierElement) {
             const certificazione = supplierElement.find('.certificazione-prodotto').val();
             const certificazioneField = supplierElement.find('.certificazione-prodotto');
             const lineaField = supplierElement.find('.linea-trasformazione');
             
             certificazioneField.removeClass('bio-red-field');
             lineaField.removeClass('bio-red-field');
             
             if (['BIO EU', 'BIO DEM', 'BIO NTD'].includes(certificazione)) {
                 certificazioneField.addClass('bio-red-field');
                 lineaField.addClass('bio-red-field');
             }
         }
         
         // Aggiunta nuovo fornitore
         function addSupplier() {
             supplierCount++;
             const template = $('#fornitore-template').html();
             const newSupplier = $(template);
             
             newSupplier.attr('data-supplier-index', supplierCount);
             newSupplier.find('.supplier-number').text(supplierCount);
             
             const agrume = $('#tipo-agrume-giornaliero').val();
             if (agrume) {
                 const yields = calculateAutoYields(agrume);
                 newSupplier.find('.resa-prima').val(yields.prima);
                 newSupplier.find('.resa-seconda').val(yields.seconda);
                 newSupplier.find('.resa-torchiato').val(yields.torchiato);
             }
             
             $('#fornitori-container').append(newSupplier);
             
             // Inizializza Select2 per destinazione multipla
             newSupplier.find('.destinazione-prima').select2({
                 placeholder: "Seleziona fino a 3 destinazioni",
                 maximumSelectionLength: 3,
                 language: {
                     maximumSelected: function() {
                         return "Puoi selezionare massimo 3 destinazioni";
                     }
                 }
             });
             
             attachSupplierEvents(newSupplier);
             updateCombinazioneOptions();
             toggleCombinazioniSection();
             updateAutoSums();
         }
         
         // Eventi per ogni fornitore
         function attachSupplierEvents(supplierElement) {
             const index = supplierElement.data('supplier-index');
             
             // Gestione campo "ALTRO" per fornitore
             supplierElement.find('.nome-fornitore').change(function() {
                 const altroField = supplierElement.find('.altro-fornitore');
                 if ($(this).val() === 'ALTRO') {
                     altroField.removeClass('hidden-field');
                 } else {
                     altroField.addClass('hidden-field').val('');
                 }
                 updateSummaryTable();
                 updateCombinazioneOptions();
             });
             
             // Gestione certificazione e colori
             supplierElement.find('.certificazione-prodotto').change(function() {
                 const altroField = supplierElement.find('.altra-certificazione');
                 const certificazione = $(this).val();
                 
                 if (certificazione === 'ALTRO') {
                     altroField.removeClass('hidden-field');
                 } else {
                     altroField.addClass('hidden-field').val('');
                 }
                 
                 updateDestinationColors(supplierElement);
                 updateBioStyles(supplierElement);
                 updateSummaryTable();
             });
             
             // Gestione bio status per colori destinazione
       supplierElement.find('.bio-prima').change(function() {
                 updateDestinationColors(supplierElement);
             });
             
             // Gestione campi "ALTRO" per tenore polpa
             supplierElement.find('.tenore-polpa-prima').change(function() {
                 const altroField = supplierElement.find('.altro-tenore-prima');
                 if ($(this).val() === 'ALTRO') {
                     altroField.removeClass('hidden-field');
                 } else {
                     altroField.addClass('hidden-field').val('');
                 }
             });
             
             supplierElement.find('.tenore-polpa-seconda').change(function() {
                 const altroField = supplierElement.find('.altro-tenore-seconda');
                 if ($(this).val() === 'ALTRO') {
                     altroField.removeClass('hidden-field');
                 } else {
                     altroField.addClass('hidden-field').val('');
                 }
             });
             
             supplierElement.find('.tenore-polpa-torchiato').change(function() {
                 const altroField = supplierElement.find('.altro-tenore-torchiato');
                 if ($(this).val() === 'ALTRO') {
                     altroField.removeClass('hidden-field');
                 } else {
                     altroField.addClass('hidden-field').val('');
                 }
             });
             
             // Gestione campi "ALTRO" per Brix
             supplierElement.find('.brix-prima, .brix-seconda, .brix-torchiato').change(function() {
                 const altroField = $(this).hasClass('brix-prima') ? supplierElement.find('.altro-brix-prima') :
                                    $(this).hasClass('brix-seconda') ? supplierElement.find('.altro-brix-seconda') :
                                    supplierElement.find('.altro-brix-torchiato');
                 
                 if ($(this).val() === 'ALTRO') {
                     altroField.removeClass('hidden-field');
                 } else {
                     altroField.addClass('hidden-field').val('');
                 }
             });
             
             // Gestione menu destinazioni multiple per succo 1ª
             supplierElement.find('.destinazione-prima').on('change', function() {
                 const selectedValues = $(this).val() || [];
                 const container = $(this).parent();
                 const bxField = container.find('.bx-concentrato');
                 const altroField = container.find('.altra-destinazione');
                 
                 if (selectedValues.includes('CONCENTRATO')) {
                     bxField.removeClass('hidden-field');
                 } else {
                     bxField.addClass('hidden-field').val('');
                 }
                 
                 if (selectedValues.includes('ALTRO')) {
                     altroField.removeClass('hidden-field');
                 } else {
                     altroField.addClass('hidden-field').val('');
                 }
             });
             
             // Gestione menu concentrato e altro destinazioni per seconda
             supplierElement.find('.destinazione-seconda').change(function() {
                 const container = $(this).parent();
                 const bxField = container.find('.bx-concentrato');
                 const altroField = container.find('.altra-destinazione');
                 
                 if ($(this).val() === 'CONCENTRATO') {
                     bxField.removeClass('hidden-field');
                     altroField.addClass('hidden-field').val('');
                 } else if ($(this).val() === 'ALTRO') {
                     altroField.removeClass('hidden-field');
                     bxField.addClass('hidden-field').val('');
                 } else {
                     bxField.addClass('hidden-field').val('');
                     altroField.addClass('hidden-field').val('');
                 }
             });
             
             // Gestione menu destinazioni per torchiato (SENZA bx-concentrato)
             supplierElement.find('.destinazione-torchiato').change(function() {
                 const container = $(this).parent();
                 const altroField = container.find('.altra-destinazione');
                 
                 if ($(this).val() === 'ALTRO') {
                     altroField.removeClass('hidden-field');
                 } else {
                     altroField.addClass('hidden-field').val('');
                 }
             });
             
             // Calcoli automatici
             supplierElement.find('.quantita-fornitore, .quantita-trasformata, .portata-impianto, .orario-inizio, .resa-prima, .resa-seconda, .resa-torchiato').on('input change', function() {
                 calculateEndTime(supplierElement);
                 calculateGiacenza(supplierElement);
                 calculateYieldQuantities(supplierElement);
                 updateTotals();
                 updateSummaryTable();
                 updateAutoSums();
             });
             
             // Rimozione fornitore
             supplierElement.find('.rimuovi-fornitore').click(function() {
                 if (confirm('Sei sicuro di voler rimuovere questo fornitore?')) {
                     supplierElement.remove();
                     updateTotals();
                     updateSummaryTable();
                     updateCombinazioneOptions();
                     toggleCombinazioniSection();
                     renumberSuppliers();
                     updateAutoSums();
                 }
             });
         }
         
         // Aggiorna colori destinazione in base a certificazione e bio status
         function updateDestinationColors(supplierElement) {
             const certificazione = supplierElement.find('.certificazione-prodotto').val();
             const bioStatus = supplierElement.find('.bio-prima').val();
             const destinazionePrimaLabel = supplierElement.find('.destinazione-prima-label');
             const destinazionePrimaSelect = supplierElement.find('.destinazione-prima').next('.select2-container');
             
             destinazionePrimaLabel.removeClass('bio-red-text bio-black-text');
             destinazionePrimaSelect.removeClass('bio-red-text bio-black-text');
             
             if (['BIO EU', 'BIO DEM', 'BIO NTD'].includes(certificazione)) {
                 if (bioStatus === 'DECLASSATO') {
                     destinazionePrimaLabel.addClass('bio-black-text');
                     destinazionePrimaSelect.find('.select2-selection').css('color', '#000000').css('font-weight', 'bold');
                 } else {
                     destinazionePrimaLabel.addClass('bio-red-text');
                     destinazionePrimaSelect.find('.select2-selection').css('color', '#dc3545').css('font-weight', 'bold');
                 }
             }
         }
         
         // Calcolo orario fine lavorazione con gestione giorno successivo
         function calculateEndTime(supplierElement) {
             const quantitaTrasformata = parseFloat(supplierElement.find('.quantita-trasformata').val()) || 0;
             const portata = parseFloat(supplierElement.find('.portata-impianto').val()) || 0;
             const orarioInizio = supplierElement.find('.orario-inizio').val();
             
             if (quantitaTrasformata > 0 && portata > 0 && orarioInizio) {
                 const durataTotaleMinuti = Math.round((quantitaTrasformata / portata) * 60);
                 const ore = Math.floor(durataTotaleMinuti / 60);
                 const minuti = durataTotaleMinuti % 60;
                 
                 const dataLavorazione = $('#data-lavorazione').val();
                 if (!dataLavorazione) {
                     supplierElement.find('.orario-fine-display').html('');
                     supplierElement.find('.durata-lavorazione').val('');
                     return;
                 }
                 
                 // Crea data/ora di inizio
                 const [oraInizio, minutiInizio] = orarioInizio.split(':').map(n => parseInt(n));
                 const dataInizio = new Date(dataLavorazione);
                 dataInizio.setHours(oraInizio, minutiInizio, 0, 0);
                 
                 // Calcola data/ora di fine
                 const dataFine = new Date(dataInizio.getTime() + durataTotaleMinuti * 60 * 1000);
                 
                 const oreFine = dataFine.getHours().toString().padStart(2, '0');
                 const minutiFine = dataFine.getMinutes().toString().padStart(2, '0');
                 let orarioFineDisplay = `${oreFine}:${minutiFine}`;
                 
                 // Controlla se la data è cambiata
                 if (dataFine.getDate() !== dataInizio.getDate()) {
                     const giornoSuccessivo = dataFine.getDate();
                     orarioFineDisplay += ` <span class="next-day">(del giorno ${giornoSuccessivo})</span>`;
                 }
                 
                 supplierElement.find('.orario-fine-display').html(orarioFineDisplay);
                 supplierElement.find('.durata-lavorazione').val(`${ore}h ${minuti}m`);
             } else {
                 supplierElement.find('.orario-fine-display').html('');
                 supplierElement.find('.durata-lavorazione').val('');
             }
         }
         
         // Calcolo giacenza per fornitore (Entrata - Trasformata)
         function calculateGiacenza(supplierElement) {
             const quantitaEntrata = parseFloat(supplierElement.find('.quantita-fornitore').val()) || 0;
             const quantitaTrasformata = parseFloat(supplierElement.find('.quantita-trasformata').val()) || 0;
             const giacenza = quantitaEntrata - quantitaTrasformata;
             
             supplierElement.find('.giacenza-fornitore').val(giacenza >= 0 ? giacenza : 0);
         }
         
         // Calcolo quantità prodotti in base alle rese
         function calculateYieldQuantities(supplierElement) {
             const quantitaTrasformata = parseFloat(supplierElement.find('.quantita-trasformata').val()) || 0;
             const resaPrima = parseFloat(supplierElement.find('.resa-prima').val()) || 0;
             
             if (quantitaTrasformata > 0) {
                 // Calcola solo la quantità prima se non è un valore da combinazione
                 const quantitaPrimaField = supplierElement.find('.quantita-prima');
                 if (!quantitaPrimaField.hasClass('combination-result')) {
                     const quantitaPrima = (quantitaTrasformata * resaPrima / 100).toFixed(1);
                     quantitaPrimaField.val(quantitaPrima);
                 }
             } else {
                 // Reset solo se non è un valore da combinazione
                 const quantitaPrimaField = supplierElement.find('.quantita-prima');
                 if (!quantitaPrimaField.hasClass('combination-result')) {
                     quantitaPrimaField.val('');
                 }
             }
             
             // Le quantità di seconda e torchiato vengono gestite da updateAutoSums()
         }
         
         // Aggiornamento totali
         function updateTotals() {
             let totaleEntrata = 0;
             let totaleTrasformata = 0;
             let totaleGiacenza = 0;
             
             $('.supplier-row').each(function() {
                 const entrata = parseFloat($(this).find('.quantita-fornitore').val()) || 0;
                 const trasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
                 const giacenza = parseFloat($(this).find('.giacenza-fornitore').val()) || 0;
                 
                 totaleEntrata += entrata;
                 totaleTrasformata += trasformata;
                 totaleGiacenza += giacenza;
             });
             
             $('#entrata-giornaliera').val(totaleEntrata);
             $('#trasformata-totale').val(totaleTrasformata);
             $('#giacenza-totale').val(totaleGiacenza);
         }
         
         // Rinumerazione fornitori dopo rimozione
         function renumberSuppliers() {
             let newCount = 0;
             $('.supplier-row').each(function() {
                 newCount++;
                 $(this).attr('data-supplier-index', newCount);
                 $(this).find('.supplier-number').text(newCount);
             });
             supplierCount = newCount;
         }
         
         // Aggiornamento tabella riepilogo
         function updateSummaryTable() {
             const tableBody = $('#riepilogo-table tbody');
             tableBody.empty();
             
             $('.supplier-row').each(function() {
                 const fornitore = $(this).find('.nome-fornitore').val() || '';
                 const altroFornitore = $(this).find('.altro-fornitore').val();
                 const nomeFornitore = fornitore === 'ALTRO' ? altroFornitore : fornitore;
                 
                 const quantitaEntrata = $(this).find('.quantita-fornitore').val() || '0';
                 const quantitaTrasformata = $(this).find('.quantita-trasformata').val() || '0';
                 const giacenza = $(this).find('.giacenza-fornitore').val() || '0';
                 const certificazione = $(this).find('.certificazione-prodotto').val() || '';
                 const linea = $(this).find('.linea-trasformazione').val() || '';
                 const orarioInizio = $(this).find('.orario-inizio').val() || '';
                 const orarioFineDisplay = $(this).find('.orario-fine-display').html() || '';
                 const durata = $(this).find('.durata-lavorazione').val() || '';
                 const supplierIndex = $(this).data('supplier-index');
                 
                 if (nomeFornitore) {
                     const isBio = certificazione.includes('BIO');
                     const isBioSpecific = ['BIO EU', 'BIO DEM', 'BIO NTD'].includes(certificazione);
                     
                     const certificationBadge = isBio ? 
                         `<span class="bio-indicator">${certificazione}</span>` : 
                         certificazione;
                     
                     const certificationClass = isBioSpecific ? 'style="color: #dc3545; font-weight: bold;"' : '';
                     const lineaClass = isBioSpecific ? 'style="color: #dc3545; font-weight: bold;"' : '';
                     
                     const row = `
                         <tr>
                             <td><strong>${nomeFornitore}</strong></td>
                             <td><span class="badge bg-primary">${quantitaEntrata} kg</span></td>
                             <td><span class="badge bg-warning">${quantitaTrasformata} kg</span></td>
                             <td><span class="badge bg-info">${giacenza} kg</span></td>
                             <td ${certificationClass}>${certificationBadge}</td>
                             <td><code ${lineaClass}>${linea}</code></td>
                             <td><span class="time-display">${orarioInizio}</span></td>
                             <td><span class="time-display">${orarioFineDisplay}</span></td>
                             <td>${durata}</td>
                             <td>
                                 <button class="btn btn-sm btn-outline-primary edit-supplier" data-index="${supplierIndex}">
                                     <i class="bi bi-pencil"></i>
                                 </button>
                                 <button class="btn btn-sm btn-outline-danger delete-supplier" data-index="${supplierIndex}">
                                     <i class="bi bi-trash"></i>
                                 </button>
                             </td>
                         </tr>
                     `;
                     tableBody.append(row);
                 }
             });
             
             // Eventi per pulsanti nella tabella
             $('.edit-supplier').click(function() {
                 const index = $(this).data('index');
                 $(`[data-supplier-index="${index}"]`)[0].scrollIntoView({ 
                     behavior: 'smooth', 
                     block: 'center' 
                 });
             });
             
             $('.delete-supplier').click(function() {
                 const index = $(this).data('index');
                 if (confirm('Confermi la rimozione di questo fornitore?')) {
                     $(`[data-supplier-index="${index}"]`).remove();
                     updateTotals();
                     updateSummaryTable();
                     updateCombinazioneOptions();
                     toggleCombinazioniSection();
                     renumberSuppliers();
                     updateAutoSums();
                 }
             });
         }
         
         // Gestione statistiche interattive
         function openStatistics() {
             $('#stats-modal').fadeIn();
             if (!chartsInitialized) {
                 initializeCharts();
                 chartsInitialized = true;
             }
             updateStatistics();
         }
         
         function closeStatistics() {
             $('#stats-modal').fadeOut();
         }
         
         function initializeCharts() {
             // Inizializza i grafici
             const ctxFornitori = document.getElementById('chartFornitori').getContext('2d');
             const ctxRese = document.getElementById('chartRese').getContext('2d');
             const ctxCertificazioni = document.getElementById('chartCertificazioni').getContext('2d');
             const ctxTimeline = document.getElementById('chartTimeline').getContext('2d');
             const ctxEfficienza = document.getElementById('chartEfficienza').getContext('2d');
             const ctxDestinazioni = document.getElementById('chartDestinazioni').getContext('2d');
             
             // Grafico Fornitori
             charts.fornitori = new Chart(ctxFornitori, {
                 type: 'pie',
                 data: {
                     labels: [],
                     datasets: [{
                         label: 'Quantità trasformata (kg)',
                         data: [],
                         backgroundColor: [
                             '#FF6384',
                             '#36A2EB',
                             '#FFCE56',
                             '#4BC0C0',
                             '#9966FF',
                             '#FF9F40'
                         ]
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         legend: {
                             position: 'bottom'
                         }
                     }
                 }
             });
             
             // Grafico Rese
             charts.rese = new Chart(ctxRese, {
                 type: 'bar',
                 data: {
                     labels: ['Succo 1ª', 'Succo 2ª', 'Torchiato'],
                     datasets: [{
                         label: 'Resa Media %',
                         data: [],
                         backgroundColor: ['#28a745', '#ffc107', '#17a2b8']
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     scales: {
                         y: {
                             beginAtZero: true,
                             max: 50
                         }
                     }
                 }
             });
             
             // Grafico Certificazioni
             charts.certificazioni = new Chart(ctxCertificazioni, {
                 type: 'doughnut',
                 data: {
                     labels: [],
                     datasets: [{
                         data: [],
                         backgroundColor: [
                             '#dc3545',
                             '#28a745',
                             '#ffc107',
                             '#17a2b8',
                             '#6c757d'
                         ]
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false
                 }
             });
             
             // Grafico Timeline
             charts.timeline = new Chart(ctxTimeline, {
                 type: 'line',
                 data: {
                     labels: [],
                     datasets: [{
                         label: 'Produzione oraria (kg)',
                         data: [],
                         borderColor: '#2a5298',
                         fill: false,
                         tension: 0.1
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     scales: {
                         y: {
                             beginAtZero: true
                         }
                     }
                 }
             });
             
             // Grafico Efficienza Linee
             charts.efficienza = new Chart(ctxEfficienza, {
                 type: 'radar',
                 data: {
                     labels: [],
                     datasets: [{
                         label: 'Efficienza %',
                         data: [],
                         backgroundColor: 'rgba(42, 82, 152, 0.2)',
                         borderColor: '#2a5298',
                         pointBackgroundColor: '#2a5298'
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     scales: {
                         r: {
                             beginAtZero: true,
                             max: 100
                         }
                     }
                 }
             });
             
             // Grafico Destinazioni
             charts.destinazioni = new Chart(ctxDestinazioni, {
                 type: 'bar',
                 data: {
                     labels: [],
                     datasets: []
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     scales: {
                         x: {
                             stacked: true
                         },
                         y: {
                             stacked: true,
                             beginAtZero: true
                         }
                     }
                 }
             });
         }
         
        function updateChartsData(data) {
    // Grafico fornitori (già funzionante)
    const fornitoriLabels = [];
    const fornitoriData = [];
    
    data.fornitori.forEach(f => {
        const nome = f.nome === 'ALTRO' ? f.altroNome : f.nome;
        if (nome && f.quantitaTrasformata > 0) {
            fornitoriLabels.push(nome);
            fornitoriData.push(f.quantitaTrasformata);
        }
    });
    
    charts.fornitori.data.labels = fornitoriLabels;
    charts.fornitori.data.datasets[0].data = fornitoriData;
    charts.fornitori.update();
    
    // Grafico rese medie (già funzionante)
    let resePrima = 0, reseSeconda = 0, reseTorchiato = 0;
    let countRese = 0;
    
    data.fornitori.forEach(f => {
        if (f.quantitaTrasformata > 0) {
            resePrima += f.rese.prima;
            reseSeconda += f.rese.seconda;
            reseTorchiato += f.rese.torchiato;
            countRese++;
        }
    });
    
    if (countRese > 0) {
        charts.rese.data.datasets[0].data = [
            (resePrima / countRese).toFixed(1),
            (reseSeconda / countRese).toFixed(1),
            (reseTorchiato / countRese).toFixed(1)
        ];
    }
    charts.rese.update();
    
    // Grafico certificazioni (già funzionante)
    const certMap = {};
    data.fornitori.forEach(f => {
        if (f.certificazione) {
            certMap[f.certificazione] = (certMap[f.certificazione] || 0) + 1;
        }
    });
    
    charts.certificazioni.data.labels = Object.keys(certMap);
    charts.certificazioni.data.datasets[0].data = Object.values(certMap);
    charts.certificazioni.update();
    
    // GRAFICO TIMELINE PRODUZIONE
    const timelineLabels = [];
    const timelineData = [];
    
    // Ordina fornitori per orario di inizio
    const fornitoriOrdinati = data.fornitori.filter(f => f.orarioInizio).sort((a, b) => {
        const timeA = a.orarioInizio.split(':').map(n => parseInt(n));
        const timeB = b.orarioInizio.split(':').map(n => parseInt(n));
        return (timeA[0] * 60 + timeA[1]) - (timeB[0] * 60 + timeB[1]);
    });
    
    // Crea serie temporale oraria
    if (fornitoriOrdinati.length > 0) {
        // Trova orario minimo e massimo
        let minOra = 24, maxOra = 0;
        fornitoriOrdinati.forEach(f => {
            const oraInizio = parseInt(f.orarioInizio.split(':')[0]);
            minOra = Math.min(minOra, oraInizio);
            
            const oraFineStr = f.orarioFineDisplay || '';
            const oraFineMatch = oraFineStr.match(/(\d{2}):(\d{2})/);
            if (oraFineMatch) {
                let oraFine = parseInt(oraFineMatch[1]);
                // Se c'è indicazione del giorno successivo, aggiungi 24
                if (oraFineStr.includes('del giorno')) {
                    oraFine += 24;
                }
                maxOra = Math.max(maxOra, oraFine);
            }
        });
        
        // Crea etichette orarie e calcola produzione per ogni ora
        for (let ora = minOra; ora <= maxOra; ora++) {
            const oraLabel = ora < 24 ? `${ora}:00` : `${ora-24}:00 (+1)`;
            timelineLabels.push(oraLabel);
            
            // Calcola produzione in questa ora
            let produzioneOra = 0;
            fornitoriOrdinati.forEach(f => {
                if (f.portataImpianto > 0 && f.orarioInizio) {
                    const [oraInizio, minInizio] = f.orarioInizio.split(':').map(n => parseInt(n));
                    const inizioMinuti = oraInizio * 60 + minInizio;
                    
                    const durataTotaleMinuti = Math.round((f.quantitaTrasformata / f.portataImpianto) * 60);
                    const fineMinuti = inizioMinuti + durataTotaleMinuti;
                    
                    const oraCorrenteInizio = ora * 60;
                    const oraCorrenteFine = (ora + 1) * 60;
                    
                    // Calcola sovrapposizione
                    if (fineMinuti > oraCorrenteInizio && inizioMinuti < oraCorrenteFine) {
                        const overlapInizio = Math.max(inizioMinuti, oraCorrenteInizio);
                        const overlapFine = Math.min(fineMinuti, oraCorrenteFine);
                        const overlapMinuti = overlapFine - overlapInizio;
                        
                        if (overlapMinuti > 0) {
                            produzioneOra += (f.portataImpianto * overlapMinuti / 60);
                        }
                    }
                }
            });
            
            timelineData.push(produzioneOra.toFixed(0));
        }
    }
    
    charts.timeline.data.labels = timelineLabels;
    charts.timeline.data.datasets[0].data = timelineData;
    charts.timeline.update();
    
    // GRAFICO EFFICIENZA LINEE
    const lineeMap = {};
    const lineeEfficienzaMap = {};
    
    data.fornitori.forEach(f => {
        if (f.lineaTrasformazione && f.portataImpianto > 0) {
            if (!lineeMap[f.lineaTrasformazione]) {
                lineeMap[f.lineaTrasformazione] = {
                    quantitaTotale: 0,
                    tempoTotale: 0,
                    portataNominale: f.portataImpianto
                };
            }
            
            lineeMap[f.lineaTrasformazione].quantitaTotale += f.quantitaTrasformata;
            
            // Calcola tempo in ore
            const tempo = f.quantitaTrasformata / f.portataImpianto;
            lineeMap[f.lineaTrasformazione].tempoTotale += tempo;
            
            // Aggiorna portata nominale se maggiore
            if (f.portataImpianto > lineeMap[f.lineaTrasformazione].portataNominale) {
                lineeMap[f.lineaTrasformazione].portataNominale = f.portataImpianto;
            }
        }
    });
    
    // Calcola efficienza per ogni linea
    const lineeLabels = [];
    const efficienzaData = [];
    
    Object.keys(lineeMap).forEach(linea => {
        lineeLabels.push(linea);
        
        // Efficienza = (quantità prodotta / tempo) / portata nominale * 100
        const dati = lineeMap[linea];
        if (dati.tempoTotale > 0) {
            const portataEffettiva = dati.quantitaTotale / dati.tempoTotale;
            const efficienza = (portataEffettiva / dati.portataNominale) * 100;
            efficienzaData.push(Math.min(efficienza, 100).toFixed(1));
        } else {
            efficienzaData.push(0);
        }
    });
    
    charts.efficienza.data.labels = lineeLabels;
    charts.efficienza.data.datasets[0].data = efficienzaData;
    charts.efficienza.update();
    
    // GRAFICO ANALISI DESTINAZIONI
    const destinazioniMap = {
        prima: {},
        seconda: {},
        torchiato: {}
    };
    
    // Raccogli tutte le destinazioni
    data.fornitori.forEach(f => {
        // Destinazioni prima (possono essere multiple)
        if (f.destinazioni.prima) {
            const destArray = f.destinazioni.prima.split(', ');
            destArray.forEach(dest => {
                if (dest) {
                    destinazioniMap.prima[dest] = (destinazioniMap.prima[dest] || 0) + (f.quantitaProdotti.prima / destArray.length);
                }
            });
        }
        
        // Destinazioni seconda
        if (f.destinazioni.seconda) {
            destinazioniMap.seconda[f.destinazioni.seconda] = (destinazioniMap.seconda[f.destinazioni.seconda] || 0) + f.quantitaProdotti.seconda;
        }
        
        // Destinazioni torchiato
        if (f.destinazioni.torchiato) {
            destinazioniMap.torchiato[f.destinazioni.torchiato] = (destinazioniMap.torchiato[f.destinazioni.torchiato] || 0) + f.quantitaProdotti.torchiato;
        }
    });
    
    // Crea set di tutte le destinazioni uniche
    const tutteDestinazioni = new Set();
    Object.keys(destinazioniMap.prima).forEach(d => tutteDestinazioni.add(d));
    Object.keys(destinazioniMap.seconda).forEach(d => tutteDestinazioni.add(d));
    Object.keys(destinazioniMap.torchiato).forEach(d => tutteDestinazioni.add(d));
    
    const destinazioniLabels = Array.from(tutteDestinazioni).sort();
    
    // Prepara datasets per grafico a barre impilate
    const datasets = [
        {
            label: 'Succo 1ª',
            data: destinazioniLabels.map(dest => (destinazioniMap.prima[dest] || 0).toFixed(1)),
            backgroundColor: '#28a745'
        },
        {
            label: 'Succo 2ª',
            data: destinazioniLabels.map(dest => (destinazioniMap.seconda[dest] || 0).toFixed(1)),
            backgroundColor: '#ffc107'
        },
        {
            label: 'Torchiato',
            data: destinazioniLabels.map(dest => (destinazioniMap.torchiato[dest] || 0).toFixed(1)),
            backgroundColor: '#17a2b8'
        }
    ];
    
    charts.destinazioni.data.labels = destinazioniLabels;
    charts.destinazioni.data.datasets = datasets;
    charts.destinazioni.update();
}             
             // Aggiorna grafico rese medie
             let resePrima = 0, reseSeconda = 0, reseTorchiato = 0;
             let countRese = 0;
             
             data.fornitori.forEach(f => {
                 if (f.quantitaTrasformata > 0) {
                     resePrima += f.rese.prima;
                     reseSeconda += f.rese.seconda;
                     reseTorchiato += f.rese.torchiato;
                     countRese++;
                 }
             });
             
             if (countRese > 0) {
                 charts.rese.data.datasets[0].data = [
                     (resePrima / countRese).toFixed(1),
                     (reseSeconda / countRese).toFixed(1),
                     (reseTorchiato / countRese).toFixed(1)
                 ];
             }
             charts.rese.update();
             
             // Aggiorna grafico certificazioni
             const certMap = {};
             data.fornitori.forEach(f => {
                 if (f.certificazione) {
                     certMap[f.certificazione] = (certMap[f.certificazione] || 0) + 1;
                 }
             });
             
             charts.certificazioni.data.labels = Object.keys(certMap);
             charts.certificazioni.data.datasets[0].data = Object.values(certMap);
             charts.certificazioni.update();
             
             // Altri aggiornamenti grafici...
         }
         
         // Eventi principali
         $('#tipo-agrume-giornaliero').change(function() {
             const agrume = $(this).val();
             if (agrume) {
                 const yields = calculateAutoYields(agrume);
                 
                 $('.supplier-row').each(function() {
                     $(this).find('.resa-prima').val(yields.prima);
                     $(this).find('.resa-seconda').val(yields.seconda);
                     $(this).find('.resa-torchiato').val(yields.torchiato);
                     calculateYieldQuantities($(this));
                 });
                 
                 updateTotals();
                 updateAutoSums();
             }
         });
         
         // Pulsante applica combinazione
         $('#applica-combinazione').click(function() {
             applyCombination();
         });
         
         // Pulsante reset combinazione
         $('#reset-combinazione').click(function() {
             resetCombination();
         });
         
         // Pulsante aggiungi fornitore
         $('#aggiungi-fornitore').click(function() {
             if (!$('#tipo-agrume-giornaliero').val()) {
                 alert('Seleziona prima il tipo di agrume');
                 return;
             }
             addSupplier();
         });
         
         // Pulsante apri statistiche
         $('#apri-statistiche').click(function() {
             openStatistics();
         });
         
         // Chiudi modal statistiche
         $('.close-stats').click(function() {
             closeStatistics();
         });
         
         // Chiudi modal cliccando fuori
         $(window).click(function(event) {
             if (event.target.id === 'stats-modal') {
                 closeStatistics();
             }
         });
         
         // Salvataggio programma
         $('#salva-programma').click(function() {
             if (!validateProgram()) {
                 return;
             }
             
             const programData = collectProgramData();
             
             console.log('Dati programma:', programData);
             
             const programId = 'PROG-' + new Date().getTime().toString().substr(-6);
             alert(`Programma salvato con successo!\nID Programma: ${programId}\nData: ${programData.dataLavorazione}\nTipo Agrume: ${programData.tipoAgrume}\nFornitori: ${programData.fornitori.length}`);
             
             updateLastRevision();
         });
         
         // Validazione programma
         function validateProgram() {
             if (!$('#tipo-agrume-giornaliero').val()) {
                 alert('Seleziona il tipo di agrume');
                 return false;
             }
             
             if (!$('#data-lavorazione').val()) {
                 alert('Inserisci la data di lavorazione');
                 return false;
             }
             
             if ($('.supplier-row').length === 0) {
                 alert('Aggiungi almeno un fornitore');
                 return false;
             }
             
             let isValid = true;
             $('.supplier-row').each(function() {
                 const fornitore = $(this).find('.nome-fornitore').val();
                 
                 if (!fornitore) {
                     isValid = false;
                     $(this)[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                     alert('Inserisci almeno il nome del fornitore');
                     return false;
                 }
             });
             
             return isValid;
         }
         
         // Raccolta dati programma
         function collectProgramData() {
             const data = {
                 tipoAgrume: $('#tipo-agrume-giornaliero').val(),
                 dataLavorazione: $('#data-lavorazione').val(),
                 entrataGiornaliera: parseFloat($('#entrata-giornaliera').val()) || 0,
                 trasformataTotale: parseFloat($('#trasformata-totale').val()) || 0,
                 giacenzaTotale: parseFloat($('#giacenza-totale').val()) || 0,
                 ultimaRevisione: $('#last-revision').text(),
                 lastCombinationSuppliers: lastCombinationSuppliers,
                 sumDetailsSeconda: sumDetailsSeconda,
                 sumDetailsTorchiato: sumDetailsTorchiato,
                 fornitori: []
             };
             
             $('.supplier-row').each(function() {
                 const destinazioniPrima = $(this).find('.destinazione-prima').val() || [];
                 const fornitore = {
                     nome: $(this).find('.nome-fornitore').val(),
                     altroNome: $(this).find('.altro-fornitore').val(),
                     quantitaEntrata: parseFloat($(this).find('.quantita-fornitore').val()) || 0,
                     quantitaTrasformata: parseFloat($(this).find('.quantita-trasformata').val()) || 0,
                     giacenza: parseFloat($(this).find('.giacenza-fornitore').val()) || 0,
                     certificazione: $(this).find('.certificazione-prodotto').val(),
                     altraCertificazione: $(this).find('.altra-certificazione').val(),
                   lineaTrasformazione: $(this).find('.linea-trasformazione').val(),
                     portataImpianto: parseFloat($(this).find('.portata-impianto').val()) || 0,
                     orarioInizio: $(this).find('.orario-inizio').val(),
                     orarioFineDisplay: $(this).find('.orario-fine-display').html(),
                     durataLavorazione: $(this).find('.durata-lavorazione').val(),
                     rese: {
                         prima: parseFloat($(this).find('.resa-prima').val()) || 0,
                         seconda: parseFloat($(this).find('.resa-seconda').val()) || 0,
                         torchiato: parseFloat($(this).find('.resa-torchiato').val()) || 0
                     },
                     quantitaProdotti: {
                         prima: parseFloat($(this).find('.quantita-prima').val()) || 0,
                         seconda: parseFloat($(this).find('.quantita-seconda').val()) || 0,
                         torchiato: parseFloat($(this).find('.quantita-torchiato').val()) || 0
                     },
                     hasCombination: $(this).find('.quantita-prima').hasClass('combination-result'),
                     isAutoSum: {
                         seconda: $(this).find('.quantita-seconda').hasClass('auto-sum-field'),
                         torchiato: $(this).find('.quantita-torchiato').hasClass('auto-sum-field')
                     },
                     caratteristicheProdotti: {
                         prima: {
                             tenorePolpa: $(this).find('.tenore-polpa-prima').val(),
                             altroTenore: $(this).find('.altro-tenore-prima').val(),
                             brix: $(this).find('.brix-prima').val(),
                             altroBrix: $(this).find('.altro-brix-prima').val(),
                             bio: $(this).find('.bio-prima').val(),
                             pastorizzato: $(this).find('.pastorizzato-prima').val(),
                             conservato: $(this).find('.conservato-prima').val(),
                             note: $(this).find('.note-prima').val()
                         },
                         seconda: {
                             tenorePolpa: $(this).find('.tenore-polpa-seconda').val(),
                             altroTenore: $(this).find('.altro-tenore-seconda').val(),
                             brix: $(this).find('.brix-seconda').val(),
                             altroBrix: $(this).find('.altro-brix-seconda').val(),
                             pastorizzato: $(this).find('.pastorizzato-seconda').val(),
                             conservato: $(this).find('.conservato-seconda').val(),
                             note: $(this).find('.note-seconda').val()
                         },
                         torchiato: {
                             tenorePolpa: $(this).find('.tenore-polpa-torchiato').val(),
                             altroTenore: $(this).find('.altro-tenore-torchiato').val(),
                             brix: $(this).find('.brix-torchiato').val(),
                             altroBrix: $(this).find('.altro-brix-torchiato').val(),
                             pastorizzato: $(this).find('.pastorizzato-torchiato').val(),
                             conservato: $(this).find('.conservato-torchiato').val(),
                             note: $(this).find('.note-torchiato').val()
                         }
                     },
                     destinazioni: {
                         prima: destinazioniPrima.join(', '),
                         seconda: $(this).find('.destinazione-seconda').val(),
                         torchiato: $(this).find('.destinazione-torchiato').val()
                     }
                 };
                 
                 data.fornitori.push(fornitore);
             });
             
             return data;
         }
         
         // Anteprima stampa
         $('#anteprima-stampa').click(function() {
             const programData = collectProgramData();
             generatePrintPreview(programData);
         });
         
         // Generazione anteprima stampa MODIFICATA
         function generatePrintPreview(data) {
             const printWindow = window.open('', '_blank');
             let printContent = `
                 <!DOCTYPE html>
                 <html>
                 <head>
                     <title>Riepilogo Programma Giornaliero - ${data.dataLavorazione}</title>
                     <style>
                         * {
                             margin: 0;
                             padding: 0;
                             box-sizing: border-box;
                         }
                         
                         body { 
                             font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                             background-color: #f5f7fa;
                             color: #333;
                             line-height: 1.6;
                         }
                         
                         .container {
                             max-width: 1200px;
                             margin: 0 auto;
                             padding: 20px;
                         }
                         
                         .header {
                             background: linear-gradient(135deg, #1e3c72, #2a5298);
                             color: white;
                             padding: 40px;
                             text-align: center;
                             border-radius: 15px;
                             box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                             margin-bottom: 40px;
                         }
                         
                         .header h1 {
                             font-size: 32px;
                             margin-bottom: 10px;
                             text-transform: uppercase;
                             letter-spacing: 2px;
                         }
                         
                         .header h2 {
                             font-size: 18px;
                             font-weight: 400;
                             opacity: 0.9;
                             margin-bottom: 20px;
                         }
                         
                         .header-info {
                             display: flex;
                             justify-content: center;
                             gap: 40px;
                             margin-top: 20px;
                         }
                         
                         .header-info-item {
                             background: rgba(255,255,255,0.1);
                             padding: 10px 20px;
                             border-radius: 10px;
                             backdrop-filter: blur(10px);
                         }
                         
                         .header-info-item strong {
                             display: block;
                             font-size: 14px;
                             opacity: 0.8;
                         }
                         
                         .header-info-item span {
                             font-size: 18px;
                             font-weight: 600;
                         }
                         
                         .supplier-grid {
                             display: grid;
                             grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                             gap: 25px;
                             margin-bottom: 40px;
                         }
                         
                         .supplier-card {
                             background: white;
                             border-radius: 12px;
                             box-shadow: 0 4px 15px rgba(0,0,0,0.08);
                             overflow: hidden;
                             transition: transform 0.3s ease;
                         }
                         
                         .supplier-card:hover {
                             transform: translateY(-5px);
                             box-shadow: 0 8px 25px rgba(0,0,0,0.12);
                         }
                         
                         .supplier-header {
                             background: #f8f9fa;
                             padding: 20px;
                             border-bottom: 3px solid #2a5298;
                         }
                         
                         .supplier-header.bio {
                             border-bottom-color: #dc3545;
                         }
                         
                         .supplier-name {
                             font-size: 20px;
                             font-weight: 600;
                             color: #1e3c72;
                             margin-bottom: 10px;
                         }
                         
                         .supplier-name.bio {
                             color: #dc3545;
                         }
                         
                         .supplier-info {
                             display: flex;
                             justify-content: space-between;
                             align-items: center;
                             margin-top: 10px;
                         }
                         
                         .certification {
                             background: #e9ecef;
                             padding: 5px 12px;
                             border-radius: 20px;
                             font-size: 12px;
                             font-weight: 600;
                         }
                         
                         .certification.bio {
                             background: #dc3545;
                             color: white;
                         }
                         
                         .line-info {
                             font-size: 14px;
                             font-weight: 500;
                             color: #6c757d;
                         }
                         
                         .line-info.bio {
                             color: #dc3545;
                             font-weight: 600;
                         }
                         
                         .supplier-body {
                             padding: 20px;
                         }
                         
                         .time-info {
                             background: #e7f3ff;
                             padding: 15px;
                             border-radius: 8px;
                             margin-bottom: 20px;
                             display: flex;
                             justify-content: space-around;
                             align-items: center;
                         }
                         
                         .time-item {
                             text-align: center;
                         }
                         
                         .time-label {
                             font-size: 12px;
                             color: #6c757d;
                             display: block;
                         }
                         
                         .time-value {
                             font-size: 18px;
                             font-weight: 600;
                             color: #1e3c72;
                         }
                         
                         .products-section {
                             margin-top: 20px;
                         }
                         
                         .product-item {
                             background: #f8f9fa;
                             padding: 15px;
                             border-radius: 8px;
                             margin-bottom: 15px;
                             border-left: 4px solid #28a745;
                         }
                         
                         .product-item.bio-red {
                             border-left-color: #dc3545;
                         }
                         
                         .product-item.bio-black {
                             border-left-color: #000;
                         }
                         
                         .product-name {
                             font-weight: 600;
                             color: #333;
                             margin-bottom: 10px;
                             display: flex;
                             justify-content: space-between;
                             align-items: center;
                         }
                         
                         .product-quantity {
                             background: #28a745;
                             color: white;
                             padding: 3px 10px;
                             border-radius: 15px;
                             font-size: 14px;
                         }
                         
                         .product-details {
                             display: grid;
                             grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                             gap: 10px;
                             margin-top: 10px;
                             font-size: 13px;
                         }
                         
                         .detail-item {
                             text-align: center;
                             padding: 5px;
                             background: white;
                             border-radius: 5px;
                         }
                         
                         .detail-label {
                             font-size: 11px;
                             color: #6c757d;
                             display: block;
                         }
                         
                         .detail-value {
                             font-weight: 600;
                             color: #333;
                         }
                         
                         .destination-info {
                             margin-top: 10px;
                             padding: 10px;
                             background: white;
                             border-radius: 5px;
                             font-size: 13px;
                         }
                         
                         .destination-label {
                             font-weight: 600;
                             color: #6c757d;
                         }
                         
                         .notes {
                             margin-top: 10px;
                             font-style: italic;
                             color: #6c757d;
                             font-size: 12px;
                         }
                         
                         .sum-info {
                             background: #fff3cd;
                             padding: 8px 12px;
                             border-radius: 5px;
                             font-size: 12px;
                             margin-top: 5px;
                             color: #856404;
                             font-weight: 600;
                         }
                         
                         .combination-info {
                             background: #fff3cd;
                             padding: 5px 10px;
                             border-radius: 5px;
                             font-size: 11px;
                             margin-top: 5px;
                         }
                         
                         .footer {
                             text-align: center;
                             margin-top: 40px;
                             padding: 20px;
                             background: #f8f9fa;
                             border-radius: 10px;
                             font-size: 12px;
                             color: #6c757d;
                         }
                         
                         .revision-info {
                             margin-top: 10px;
                             font-weight: 600;
                         }
                         
                         @media print {
                             body {
                                 background: white;
                             }
                             
                             .container {
                                 max-width: 100%;
                             }
                             
                             .supplier-card {
                                 break-inside: avoid;
                                 page-break-inside: avoid;
                             }
                             
                             .header {
                                 background: #1e3c72 !important;
                                 -webkit-print-color-adjust: exact;
                                 print-color-adjust: exact;
                             }
                         }
                     </style>
                 </head>
                 <body>
                     <div class="container">
                         <div class="header">
                             <h1>Riepilogo Programma Giornaliero Trasformazione Frutta</h1>
                             <h2>Sistema di Gestione Produzione - Simone Gatto</h2>
                             <div class="header-info">
                                 <div class="header-info-item">
                                     <strong>Data Lavorazione</strong>
                                     <span>${data.dataLavorazione ? new Date(data.dataLavorazione).toLocaleDateString('it-IT') : 'Non specificata'}</span>
                                 </div>
                                 <div class="header-info-item">
                                     <strong>Tipo Agrume</strong>
                                     <span>${data.tipoAgrume || 'Non specificato'}</span>
                                 </div>
                                 <div class="header-info-item">
                                     <strong>Totale Trasformato</strong>
                                     <span>${data.trasformataTotale.toLocaleString()} kg</span>
                                 </div>
                             </div>
                         </div>
                         
                         <div class="supplier-grid">
             `;
             
             // Genera card per ogni fornitore
             data.fornitori.forEach((fornitore, index) => {
                 const nomeFornitore = fornitore.nome === 'ALTRO' ? fornitore.altroNome : fornitore.nome;
                 const isBio = ['BIO EU', 'BIO DEM', 'BIO NTD'].includes(fornitore.certificazione);
                 const bioClass = isBio ? 'bio' : '';
                 const bioStatusPrima = fornitore.caratteristicheProdotti.prima.bio;
                 const primaClass = isBio ? (bioStatusPrima === 'DECLASSATO' ? 'bio-black' : 'bio-red') : '';
                 
                 const orarioFineClean = fornitore.orarioFineDisplay ? 
                     fornitore.orarioFineDisplay.replace(/<[^>]*>/g, '').replace('del giorno', 'g.') : '';
                 
                 printContent += `
                     <div class="supplier-card">
                         <div class="supplier-header ${bioClass}">
                             <div class="supplier-name ${bioClass}">${nomeFornitore || 'Non specificato'}</div>
                             <div class="supplier-info">
                                 <span class="certification ${bioClass}">${fornitore.certificazione || 'N/D'}</span>
                                 <span class="line-info ${bioClass}">${fornitore.lineaTrasformazione || 'N/D'}</span>
                             </div>
                         </div>
                         
                         <div class="supplier-body">
                             <div class="time-info">
                                 <div class="time-item">
                                     <span class="time-label">Inizio</span>
                                     <span class="time-value">${fornitore.orarioInizio || '-'}</span>
                                 </div>
                                 <div class="time-item">
                                     <span class="time-label">Fine</span>
                                     <span class="time-value">${orarioFineClean || '-'}</span>
                                 </div>
                             </div>
                             
                             <div class="products-section">
                 `;
                 
                 // Succo 1ª
                 printContent += `
                     <div class="product-item ${primaClass}">
                         <div class="product-name">
                             <span>Succo 1ª</span>
                             <span class="product-quantity">${fornitore.quantitaProdotti.prima} kg</span>
                         </div>
                 `;
                 
                 if (fornitore.hasCombination) {
                     printContent += `<div class="combination-info">Combinazione: ${data.lastCombinationSuppliers}</div>`;
                 }
                 
                 printContent += `
                         <div class="product-details">
                             <div class="detail-item">
                                 <span class="detail-label">Tenore Polpa</span>
                                 <span class="detail-value">${fornitore.caratteristicheProdotti.prima.tenorePolpa || '-'}</span>
                             </div>
                             <div class="detail-item">
                                 <span class="detail-label">Brix</span>
                                 <span class="detail-value">${fornitore.caratteristicheProdotti.prima.brix || '-'}</span>
                             </div>
                             <div class="detail-item">
                                 <span class="detail-label">Pastorizzato</span>
                                 <span class="detail-value">${fornitore.caratteristicheProdotti.prima.pastorizzato || '-'}</span>
                             </div>
                             <div class="detail-item">
                                 <span class="detail-label">Conservato</span>
                                 <span class="detail-value">${fornitore.caratteristicheProdotti.prima.conservato || '-'}</span>
                             </div>
                         </div>
                         <div class="destination-info">
                             <span class="destination-label">Destinazione:</span> ${fornitore.destinazioni.prima || 'Non specificata'}
                         </div>
                 `;
                 
                 if (fornitore.caratteristicheProdotti.prima.note) {
                     printContent += `<div class="notes">Note: ${fornitore.caratteristicheProdotti.prima.note}</div>`;
                 }
                 
                 printContent += `</div>`;
                 
                 // Succo 2ª - Mostra solo totale se è l'ultimo fornitore e c'è auto-sum
                 if (fornitore.isAutoSum.seconda && index === data.fornitori.length - 1) {
                     printContent += `
                         <div class="product-item">
                             <div class="product-name">
                                 <span>Succo 2ª - TOTALE FORNITORI</span>
                                 <span class="product-quantity">${fornitore.quantitaProdotti.seconda} kg</span>
                             </div>
                     `;
                     
                     if (data.sumDetailsSeconda && data.sumDetailsSeconda.length > 1) {
                         const detailsText = formatSumDetails(data.sumDetailsSeconda, 'seconda');
                         printContent += `<div class="sum-info">Dettaglio: ${detailsText}</div>`;
                     }
                 } else if (!fornitore.isAutoSum.seconda && fornitore.quantitaProdotti.seconda > 0) {
                     // Mostra normale solo se non è auto-sum
                     printContent += `
                         <div class="product-item">
                             <div class="product-name">
                                 <span>Succo 2ª</span>
                                 <span class="product-quantity">${fornitore.quantitaProdotti.seconda} kg</span>
                             </div>
                     `;
                 } else {
                     // Non mostrare nulla per fornitori con auto-sum (tranne l'ultimo)
                     printContent += '<!-- Succo 2ª incluso nel totale finale -->';
                 }
                 
                 if ((!fornitore.isAutoSum.seconda && fornitore.quantitaProdotti.seconda > 0) || 
                     (fornitore.isAutoSum.seconda && index === data.fornitori.length - 1)) {
                     printContent += `
                             <div class="product-details">
                                 <div class="detail-item">
                                     <span class="detail-label">Tenore Polpa</span>
                                     <span class="detail-value">${fornitore.caratteristicheProdotti.seconda.tenorePolpa || '-'}</span>
                                 </div>
                                 <div class="detail-item">
                                     <span class="detail-label">Brix</span>
                                     <span class="detail-value">${fornitore.caratteristicheProdotti.seconda.brix || '-'}</span>
                                 </div>
                                 <div class="detail-item">
                                     <span class="detail-label">Pastorizzato</span>
                                     <span class="detail-value">${fornitore.caratteristicheProdotti.seconda.pastorizzato || '-'}</span>
                                 </div>
                                 <div class="detail-item">
                                     <span class="detail-label">Conservato</span>
                                     <span class="detail-value">${fornitore.caratteristicheProdotti.seconda.conservato || '-'}</span>
                                 </div>
                             </div>
                             <div class="destination-info">
                                 <span class="destination-label">Destinazione:</span> ${fornitore.destinazioni.seconda || 'Non specificata'}
                             </div>
                     `;
                     
                     if (fornitore.caratteristicheProdotti.seconda.note) {
                         printContent += `<div class="notes">Note: ${fornitore.caratteristicheProdotti.seconda.note}</div>`;
                     }
                     
                     printContent += `</div>`;
                 }
                 
                 // Torchiato - Stessa logica del succo 2ª
                 if (fornitore.isAutoSum.torchiato && index === data.fornitori.length - 1) {
                     printContent += `
                         <div class="product-item">
                             <div class="product-name">
                                 <span>Torchiato - TOTALE FORNITORI</span>
                                 <span class="product-quantity">${fornitore.quantitaProdotti.torchiato} kg</span>
                             </div>
                     `;
                     
                     if (data.sumDetailsTorchiato && data.sumDetailsTorchiato.length > 1) {
                         const detailsText = formatSumDetails(data.sumDetailsTorchiato, 'torchiato');
                         printContent += `<div class="sum-info">Dettaglio: ${detailsText}</div>`;
                     }
                 } else if (!fornitore.isAutoSum.torchiato && fornitore.quantitaProdotti.torchiato > 0) {
                     printContent += `
                         <div class="product-item">
                             <div class="product-name">
                                 <span>Torchiato</span>
                                 <span class="product-quantity">${fornitore.quantitaProdotti.torchiato} kg</span>
                             </div>
                     `;
                 } else {
                     printContent += '<!-- Torchiato incluso nel totale finale -->';
                 }
                 
                 if ((!fornitore.isAutoSum.torchiato && fornitore.quantitaProdotti.torchiato > 0) || 
                     (fornitore.isAutoSum.torchiato && index === data.fornitori.length - 1)) {
                     printContent += `
                             <div class="product-details">
                                 <div class="detail-item">
                                     <span class="detail-label">Tenore Polpa</span>
                                     <span class="detail-value">${fornitore.caratteristicheProdotti.torchiato.tenorePolpa || '-'}</span>
                                 </div>
                                 <div class="detail-item">
                                     <span class="detail-label">Brix</span>
                                     <span class="detail-value">${fornitore.caratteristicheProdotti.torchiato.brix || '-'}</span>
                                 </div>
                                 <div class="detail-item">
                                     <span class="detail-label">Pastorizzato</span>
                                     <span class="detail-value">${fornitore.caratteristicheProdotti.torchiato.pastorizzato || '-'}</span>
                                 </div>
                                 <div class="detail-item">
                                     <span class="detail-label">Conservato</span>
                                     <span class="detail-value">${fornitore.caratteristicheProdotti.torchiato.conservato || '-'}</span>
                                 </div>
                             </div>
                             <div class="destination-info">
                                 <span class="destination-label">Destinazione:</span> ${fornitore.destinazioni.torchiato || 'Non specificata'}
                             </div>
                     `;
                     
                     if (fornitore.caratteristicheProdotti.torchiato.note) {
                         printContent += `<div class="notes">Note: ${fornitore.caratteristicheProdotti.torchiato.note}</div>`;
                     }
                     
                     printContent += `</div>`;
                 }
                 
                 printContent += `
                                 </div>
                             </div>
                         </div>
                     </div>
                 `;
             });
             
             printContent += `
                         </div>
                         
                         <div class="footer">
                             <p>Documento generato automaticamente il ${new Date().toLocaleString('it-IT')}</p>
                             <p>Sistema di Gestione Produzione - Simone Gatto</p>
                             <p class="revision-info">Ultima revisione: ${data.ultimaRevisione}</p>
                         </div>
                     </div>
                 </body>
                 </html>
             `;
             
             printWindow.document.write(printContent);
             printWindow.document.close();
             printWindow.focus();
         }
         
         // Reset programma
         $('#reset-programma').click(function() {
             if (confirm('Attenzione: questa operazione cancellerà tutti i dati inseriti. Continuare?')) {
                 location.reload();
             }
         });
         
         // Inizializzazione
         initCurrentDate();
         
         console.log('Sistema Programma Giornaliero Trasformazione inizializzato con successo');
     });
 </script>
</body>
</html>
